<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team KPI & Issue Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f6f9;
            color: #333;
        }
        h1, h2 {
            color: #1a6dcc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #1a6dcc;
            color: white;
        }
        textarea, input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            padding: 10px 15px;
            background-color: #1a6dcc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #155db3;
        }
        canvas {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .download-btn {
            float: right;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<h1>Team KPI & Issue Tracker</h1>

<h2>
    KPI Goals & Progress
    <button class="download-btn" onclick="downloadTableAsExcel('kpi-table', 'KPI_Data.xlsx')">Download as Excel</button>
</h2>
<table id="kpi-table">
    <thead>
        <tr>
            <th>Core KPI</th>
            <th>Key Actions</th>
            <th>This Week Review</th>
            <th>Next Week Plan</th>
            <th>Owner</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><input placeholder="e.g. Customer Satisfaction ≥ 90%"></td>
            <td><input placeholder="e.g. Improve response speed"></td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
            <td><input placeholder="e.g. John Doe"></td>
        </tr>
    </tbody>
</table>
<button onclick="addRow('kpi-table')">➕ Add KPI</button>

<h2>
    Issue Tracking
    <button class="download-btn" onclick="downloadTableAsExcel('issue-table', 'Issue_Data.xlsx')">Download as Excel</button>
</h2>
<table id="issue-table">
    <thead>
        <tr>
            <th>Description</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Estimated Completion</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><textarea></textarea></td>
            <td><input></td>
            <td>
                <select>
                    <option>Pending</option>
                    <option>In Progress</option>
                    <option>Done</option>
                </select>
            </td>
            <td><input type="date"></td>
        </tr>
    </tbody>
</table>
<button onclick="addRow('issue-table')">➕ Add Issue</button>

<h2>Completion Statistics by Owner</h2>
<canvas id="progressChart" width="600" height="300"></canvas>

<script>
function addRow(tableId) {
    const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    const row = table.rows[0].cloneNode(true);
    row.querySelectorAll('input, textarea').forEach(el => el.value = "");
    row.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
    table.appendChild(row);
}

function updateChart() {
    const rows = document.getElementById('issue-table').getElementsByTagName('tbody')[0].rows;
    const counts = {};
    for (let row of rows) {
        const name = row.cells[1].querySelector('input').value.trim();
        const status = row.cells[2].querySelector('select').value;
        if (!name) continue;
        if (!counts[name]) counts[name] = { total: 0, done: 0 };
        counts[name].total++;
        if (status === 'Done') counts[name].done++;
    }

    const labels = Object.keys(counts);
    const data = labels.map(name => {
        const c = counts[name];
        return c.total === 0 ? 0 : Math.round((c.done / c.total) * 100);
    });

    progressChart.data.labels = labels;
    progressChart.data.datasets[0].data = data;
    progressChart.update();
}

const ctx = document.getElementById('progressChart').getContext('2d');
const progressChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'Completion Rate (%)',
            data: [],
            backgroundColor: '#2c87e6'
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: value => value + '%'
                }
            }
        }
    }
});

// Auto-update chart every 5s
setInterval(updateChart, 5000);

// Download as Excel function (SheetJS)
function downloadTableAsExcel(tableId, filename) {
    const table = document.getElementById(tableId);
    const wb = XLSX.utils.book_new();

    // Extract table data, including current inputs/textareas/selects values
    const ws_data = [];
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => headers.push(th.innerText));
    ws_data.push(headers);

    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            let val = '';
            if (td.querySelector('input')) {
                val = td.querySelector('input').value;
            } else if (td.querySelector('textarea')) {
                val = td.querySelector('textarea').value;
            } else if (td.querySelector('select')) {
                val = td.querySelector('select').value;
            }
            row.push(val);
        });
        ws_data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename);
}
</script>

</body>
</html>
