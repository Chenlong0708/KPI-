<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team KPI & Issue Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f6f9;
            color: #333;
        }
        h1, h2 {
            color: #1a6dcc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #1a6dcc;
            color: white;
        }
        textarea, input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            padding: 10px 15px;
            background-color: #1a6dcc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #155db3;
        }
        canvas {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1>Team KPI & Issue Tracker</h1>

<h2>KPI Goals & Progress</h2>
<table id="kpi-table">
    <thead>
        <tr>
            <th>Core KPI</th>
            <th>Key Actions</th>
            <th>This Week Review</th>
            <th>Next Week Plan</th>
            <th>Owner</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><input placeholder="e.g. Customer satisfaction ≥ 90%"></td>
            <td><input placeholder="e.g. Improve response time"></td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
            <td><input placeholder="e.g. Jack Zhang"></td>
        </tr>
    </tbody>
</table>
<button onclick="addRow('kpi-table')">➕ Add KPI</button>

<h2>Issue Tracking List</h2>
<table id="issue-table">
    <thead>
        <tr>
            <th>Issue Description</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Estimated Completion</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><textarea></textarea></td>
            <td><input></td>
            <td><select>
                <option>To Do</option>
                <option>In Progress</option>
                <option>Done</option>
            </select></td>
            <td><input type="date"></td>
        </tr>
    </tbody>
</table>
<button onclick="addRow('issue-table')">➕ Add Issue</button>

<h2>Owner Completion Rate Chart</h2>
<canvas id="progressChart" width="600" height="300"></canvas>

<script>
function addRow(tableId) {
    const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    const row = table.rows[0].cloneNode(true);
    row.querySelectorAll('input, textarea').forEach(el => el.value = "");
    row.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
    table.appendChild(row);
    triggerSync(tableId); // 新增行后也同步
}

function updateChart() {
    const rows = document.getElementById('issue-table').getElementsByTagName('tbody')[0].rows;
    const counts = {};
    for (let row of rows) {
        const name = row.cells[1].querySelector('input').value.trim();
        const status = row.cells[2].querySelector('select').value;
        if (!name) continue;
        if (!counts[name]) counts[name] = { total: 0, done: 0 };
        counts[name].total++;
        if (status === 'Done') counts[name].done++;
    }

    const labels = Object.keys(counts);
    const data = labels.map(name => {
        const c = counts[name];
        return Math.round((c.done / c.total) * 100);
    });

    progressChart.data.labels = labels;
    progressChart.data.datasets[0].data = data;
    progressChart.update();
}

const ctx = document.getElementById('progressChart').getContext('2d');
const progressChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'Completion Rate (%)',
            data: [],
            backgroundColor: '#2c87e6'
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: value => value + '%'
                }
            }
        }
    }
});

// Auto update chart every 5 seconds
setInterval(updateChart, 5000);
</script>

<!-- 多人协作实时编辑核心功能开始 -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// 请将下行地址替换为你的 Socket.io 服务器地址
const socket = io('http://你的服务器IP:端口');

function getTableData(tableId) {
    const table = document.getElementById(tableId);
    const data = [];
    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = [];
        row.querySelectorAll('input, textarea, select').forEach(el => {
            rowData.push(el.value);
        });
        data.push(rowData);
    });
    return data;
}

function setTableData(tableId, data) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    // 清空
    while (tbody.rows.length > 0) {
        tbody.deleteRow(0);
    }
    // 按新数据补充
    data.forEach(rowData => {
        const tr = table.rows[1] ? table.rows[1].cloneNode(true) : table.rows[0].cloneNode(true);
        tr.querySelectorAll('input, textarea, select').forEach((el, idx) => {
            el.value = rowData[idx] || "";
        });
        tbody.appendChild(tr);
    });
    // 若无数据，补一行空的
    if (data.length === 0 && table.rows[0]) {
        const tr = table.rows[0].cloneNode(true);
        tr.querySelectorAll('input, textarea, select').forEach(el => el.value = "");
        tbody.appendChild(tr);
    }
    updateChart();
}

function triggerSync(tableId) {
    const data = getTableData(tableId);
    socket.emit('table-update', { tableId, data });
}

// 监听输入和结构变更
['kpi-table', 'issue-table'].forEach(tableId => {
    document.getElementById(tableId).addEventListener('input', () => triggerSync(tableId));
});

// 监听按钮新增行
document.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(() => {
            ['kpi-table', 'issue-table'].forEach(tableId => triggerSync(tableId));
        }, 10);
    });
});

// 接收并更新
socket.on('table-update', ({ tableId, data }) => {
    setTableData(tableId, data);
});

// 新连接立即获取最新内容
socket.on('connect', () => {
    socket.emit('get-initial');
});
socket.on('initial-data', (tables) => {
    Object.keys(tables).forEach(tableId => setTableData(tableId, tables[tableId]));
});
</script>
<!-- 多人协作实时编辑核心功能结束 -->

</body>
</html>
