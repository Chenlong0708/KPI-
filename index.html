<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>团队KPI管理与问题跟踪</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 30px; }
        .progress { height: 20px; }
        .rank-table th, .rank-table td { text-align: center; }
    </style>
</head>
<body>
    <!-- 语言切换按钮 -->
    <button id="langToggle" class="btn btn-secondary mb-3">English</button>
    <h1 class="mb-4" id="mainTitle">团队KPI管理与问题跟踪</h1>
    <!-- 问题点跟踪统计 -->
    <h2 id="issueTitle">问题点跟踪统计</h2>
    <table class="table table-bordered align-middle" id="issueTable">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th id="issueDescTh">问题描述</th>
                <th id="issueOwnerTh">责任人</th>
                <th id="issueStatusTh">状态</th>
                <th id="issueProgressTh">进度</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>接口文档未完善</td>
                <td>张三</td>
                <td>进行中</td>
                <td><div class="progress"><div class="progress-bar bg-warning" style="width: 50%;">50%</div></div></td>
            </tr>
            <tr>
                <td>2</td>
                <td>测试用例覆盖率低</td>
                <td>李四</td>
                <td>未开始</td>
                <td><div class="progress"><div class="progress-bar bg-danger" style="width: 0%;">0%</div></div></td>
            </tr>
            <tr>
                <td>3</td>
                <td>性能优化未完成</td>
                <td>王五</td>
                <td>已完成</td>
                <td><div class="progress"><div class="progress-bar bg-success" style="width: 100%;">100%</div></div></td>
            </tr>
        </tbody>
    </table>
    <p id="issueCountLabel">当前问题总数：<span id="issueCount"></span></p>

    <!-- 问题完成率排名 -->
    <h3 id="issueRankTitle" class="mt-4">问题完成率排名</h3>
    <table class="table table-bordered" id="issueRankTable">
        <thead class="table-dark">
            <tr>
                <th id="issueRankTh">排名</th>
                <th id="issueRankDescTh">问题描述</th>
                <th id="issueRankOwnerTh">责任人</th>
                <th id="issueRankStatusTh">状态</th>
                <th id="issueRankProgressTh">进度</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- KPI及关键措施 -->
    <h2 class="mt-5" id="kpiTitle">KPI及关键措施</h2>
    <div id="kpiList"></div>
    <button class="btn btn-primary mt-2" onclick="addKPI()" id="addKpiBtn">添加KPI</button>
    <button class="btn btn-outline-success mt-2" onclick="saveWeek()" id="saveBtn">保存本周内容</button>
    <button class="btn btn-outline-info mt-2" onclick="reviewWeeks()" id="reviewBtn">回顾历史内容</button>

    <!-- 人员完成度排名 -->
    <h2 class="mt-5" id="rankTitle">人员完成度排名</h2>
    <table class="table table-striped rank-table" id="rankTable">
        <thead class="table-dark">
            <tr>
                <th id="rankTh">排名</th>
                <th id="nameTh">姓名</th>
                <th id="finishedTh">完成任务数</th>
                <th id="totalTh">总任务数</th>
                <th id="rateTh">完成率</th>
            </tr>
        </thead>
        <tbody>
            <!-- JS自动填充 -->
        </tbody>
    </table>

    <script>
        // 多语言字典
        const langText = {
            'zh': {
                mainTitle: "团队KPI管理与问题跟踪",
                issueTitle: "问题点跟踪统计",
                kpiTitle: "KPI及关键措施",
                addKPI: "添加KPI",
                save: "保存本周内容",
                review: "回顾历史内容",
                addMeasure: "添加措施",
                delete: "删除",
                input: "新增关键措施，每行一个",
                prompt: "请输入新KPI名称：",
                issueDesc: "问题描述",
                issueOwner: "责任人",
                issueStatus: "状态",
                issueProgress: "进度",
                issueCount: "当前问题总数：",
                rankTitle: "人员完成度排名",
                rank: "排名",
                name: "姓名",
                finished: "完成任务数",
                total: "总任务数",
                rate: "完成率",
                saveSuccess: "保存成功！",
                noHistory: "暂无历史内容",
                issueRankTitle: "问题完成率排名",
                issueRankDesc: "问题描述",
                issueRankOwner: "责任人",
                issueRankStatus: "状态",
                issueRankProgress: "进度",
                issueRankRank: "排名"
            },
            'en': {
                mainTitle: "Team KPI Management & Issue Tracking",
                issueTitle: "Issue Tracking",
                kpiTitle: "KPI & Key Actions",
                addKPI: "Add KPI",
                save: "Save This Week",
                review: "Review History",
                addMeasure: "Add Action",
                delete: "Delete",
                input: "Add key actions, one per line",
                prompt: "Enter new KPI name:",
                issueDesc: "Issue",
                issueOwner: "Owner",
                issueStatus: "Status",
                issueProgress: "Progress",
                issueCount: "Total Issues:",
                rankTitle: "Ranking",
                rank: "Rank",
                name: "Name",
                finished: "Finished Tasks",
                total: "Total Tasks",
                rate: "Finish Rate",
                saveSuccess: "Saved!",
                noHistory: "No history yet",
                issueRankTitle: "Issue Completion Ranking",
                issueRankDesc: "Issue",
                issueRankOwner: "Owner",
                issueRankStatus: "Status",
                issueRankProgress: "Progress",
                issueRankRank: "Rank"
            }
        };

        let isEn = false;

        // 问题统计
        document.getElementById('issueCount').innerText = document.querySelectorAll('#issueTable tbody tr').length;

        // KPI及关键措施数据
        let kpis = [
            { name: "代码规范执行", measures: ["定期代码评审", "自动化检查"] },
            { name: "交付准时率", measures: ["制定详细计划"] }
        ];

        // 渲染KPI及关键措施
        function renderKPIs() {
            const kpiList = document.getElementById('kpiList');
            kpiList.innerHTML = '';
            kpis.forEach((kpi, idx) => {
                let html = `<div class="mb-3 border p-2">
                    <strong>KPI: ${kpi.name}</strong>
                    <ul class="mb-2">`;
                kpi.measures.forEach((msr, i) => {
                    html += `<li>${msr} <button class="btn btn-sm btn-danger" onclick="removeMeasure(${idx},${i})">${isEn ? langText.en.delete : langText.zh.delete}</button></li>`;
                });
                html += `</ul>
                    <div class="input-group mb-1" style="max-width:400px;">
                        <textarea class="form-control" id="input-${idx}" rows="3" placeholder="${isEn ? langText.en.input : langText.zh.input}"></textarea>
                        <button class="btn btn-success" onclick="addMeasure(${idx})">${isEn ? langText.en.addMeasure : langText.zh.addMeasure}</button>
                    </div>
                </div>`;
                kpiList.innerHTML += html;
            });
        }

        function addMeasure(idx) {
            const input = document.getElementById(`input-${idx}`);
            const lines = input.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (lines.length) {
                kpis[idx].measures.push(...lines);
                input.value = '';
                renderKPIs();
            }
        }

        function removeMeasure(kpiIdx, msrIdx) {
            kpis[kpiIdx].measures.splice(msrIdx, 1);
            renderKPIs();
        }

        function addKPI() {
            const newName = prompt(isEn ? langText.en.prompt : langText.zh.prompt);
            if (newName && newName.trim()) {
                kpis.push({ name: newName.trim(), measures: [] });
                renderKPIs();
            }
        }

        renderKPIs();

        // 多语言切换
        document.getElementById('langToggle').onclick = function() {
            isEn = !isEn;
            this.textContent = isEn ? '中文' : 'English';
            document.getElementById('mainTitle').textContent = isEn ? langText.en.mainTitle : langText.zh.mainTitle;
            document.getElementById('issueTitle').textContent = isEn ? langText.en.issueTitle : langText.zh.issueTitle;
            document.getElementById('kpiTitle').textContent = isEn ? langText.en.kpiTitle : langText.zh.kpiTitle;
            document.getElementById('addKpiBtn').textContent = isEn ? langText.en.addKPI : langText.zh.addKPI;
            document.getElementById('saveBtn').textContent = isEn ? langText.en.save : langText.zh.save;
            document.getElementById('reviewBtn').textContent = isEn ? langText.en.review : langText.zh.review;
            document.getElementById('issueDescTh').textContent = isEn ? langText.en.issueDesc : langText.zh.issueDesc;
            document.getElementById('issueOwnerTh').textContent = isEn ? langText.en.issueOwner : langText.zh.issueOwner;
            document.getElementById('issueStatusTh').textContent = isEn ? langText.en.issueStatus : langText.zh.issueStatus;
            document.getElementById('issueProgressTh').textContent = isEn ? langText.en.issueProgress : langText.zh.issueProgress;
            document.getElementById('issueCountLabel').childNodes[0].textContent = isEn ? langText.en.issueCount : langText.zh.issueCount;
            document.getElementById('rankTitle').textContent = isEn ? langText.en.rankTitle : langText.zh.rankTitle;
            document.getElementById('rankTh').textContent = isEn ? langText.en.rank : langText.zh.rank;
            document.getElementById('nameTh').textContent = isEn ? langText.en.name : langText.zh.name;
            document.getElementById('finishedTh').textContent = isEn ? langText.en.finished : langText.zh.finished;
            document.getElementById('totalTh').textContent = isEn ? langText.en.total : langText.zh.total;
            document.getElementById('rateTh').textContent = isEn ? langText.en.rate : langText.zh.rate;
            document.getElementById('issueRankTitle').textContent = isEn ? langText.en.issueRankTitle : langText.zh.issueRankTitle;
            document.getElementById('issueRankTh').textContent = isEn ? langText.en.issueRankRank : langText.zh.issueRankRank;
            document.getElementById('issueRankDescTh').textContent = isEn ? langText.en.issueRankDesc : langText.zh.issueRankDesc;
            document.getElementById('issueRankOwnerTh').textContent = isEn ? langText.en.issueRankOwner : langText.zh.issueRankOwner;
            document.getElementById('issueRankStatusTh').textContent = isEn ? langText.en.issueRankStatus : langText.zh.issueRankStatus;
            document.getElementById('issueRankProgressTh').textContent = isEn ? langText.en.issueRankProgress : langText.zh.issueRankProgress;
            renderKPIs();
            renderIssueRankTable();
        };

        // 每周内容保存与回顾
        function saveWeek() {
            const weeks = JSON.parse(localStorage.getItem('weeks') || '[]');
            weeks.push({
                date: new Date().toLocaleDateString(),
                kpis: JSON.parse(JSON.stringify(kpis))
            });
            localStorage.setItem('weeks', JSON.stringify(weeks));
            alert(isEn ? langText.en.saveSuccess : langText.zh.saveSuccess);
        }
        function reviewWeeks() {
            const weeks = JSON.parse(localStorage.getItem('weeks') || '[]');
            let msg = weeks.map((w,i) =>
                `[${i+1}] ${w.date}\n` +
                w.kpis.map(k=>`KPI: ${k.name}\n${k.measures.map(m=>'- '+m).join('\n')}`).join('\n')
            ).join('\n\n');
            alert(msg || (isEn ? langText.en.noHistory : langText.zh.noHistory));
        }

        // 人员完成度数据
        const memberData = [
            { name: "张三", finished: 8, total: 10 },
            { name: "李四", finished: 5, total: 10 },
            { name: "王五", finished: 10, total: 10 }
        ];

        // 排名&渲染（按完成率降序）
        memberData.sort((a, b) => (b.finished/b.total) - (a.finished/b.total));
        const rankTbody = document.querySelector('#rankTable tbody');
        memberData.forEach((m, idx) => {
            const percent = ((m.finished/m.total)*100).toFixed(0) + '%';
            rankTbody.innerHTML += `
                <tr>
                    <td>${idx+1}</td>
                    <td>${m.name}</td>
                    <td>${m.finished}</td>
                    <td>${m.total}</td>
                    <td>
                        <div class="progress">
                          <div class="progress-bar" style="width:${percent};">${percent}</div>
                        </div>
                    </td>
                </tr>
            `;
        });

        // 问题完成率排名
        function parseProgress(str) {
            if (str.includes('%')) return Number(str.replace('%', ''));
            return 0;
        }
        function renderIssueRankTable() {
            const rows = Array.from(document.querySelectorAll('#issueTable tbody tr')).map(tr => {
                const tds = tr.querySelectorAll('td');
                // 获取进度百分比文本
                let progressText = tds[4].innerText.trim();
                // 兼容直接为0%的情况
                let progress = parseProgress(progressText);
                return {
                    issue: tds[1].innerText,
                    owner: tds[2].innerText,
                    status: tds[3].innerText,
                    progressText: progressText,
                    progress: progress
                };
            });
            rows.sort((a, b) => b.progress - a.progress);

            const tbody = document.querySelector('#issueRankTable tbody');
            tbody.innerHTML = '';
            rows.forEach((row, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${row.issue}</td>
                        <td>${row.owner}</td>
                        <td>${row.status}</td>
                        <td>${row.progressText}</td>
                    </tr>
                `;
            });
        }
        // 初始化时渲染一次
        renderIssueRankTable();

    </script>
</body>
</html>
