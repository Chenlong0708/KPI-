<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Issue Tracker - McKinsey Style</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 32px 40px;
    }
    h1 {
      text-align: center;
      font-size: 2.2em;
      color: #23395d;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    .date {
      text-align: right;
      color: #888;
      margin-bottom: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      margin-bottom: 24px;
    }
    th, td {
      border: 1px solid #dde2e8;
      padding: 12px 8px;
      text-align: left;
    }
    th {
      background: #eaf0f7;
      color: #23395d;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #f7fafd;
    }
    .add-issue {
      background: #23395d;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      float: right;
      margin-bottom: 18px;
      transition: background 0.2s;
    }
    .add-issue:hover {
      background: #43689b;
    }
    .clear {
      clear: both;
    }
    .footer {
      text-align: center;
      color: #aaa;
      font-size: 0.9em;
      margin-top: 30px;
    }
    #closeRateChart {
      max-width: 600px;
      margin: 20px auto 0 auto;
      display: block;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 20px;
    }
  </style>
  <!-- 引入 Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Daily Issue Tracker</h1>
    <div class="date" id="today"></div>
    <button class="add-issue" onclick="addRow()">Add Issue</button>
    <div class="clear"></div>
    <table id="issueTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Description</th>
          <th>Owner</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Solution/Remarks</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be inserted dynamically -->
      </tbody>
    </table>
    <canvas id="closeRateChart"></canvas>
    <div class="footer">
      McKinsey Style · Team Daily Issue Tracker
    </div>
  </div>
  <script>
    // Show today's date
    document.getElementById('today').innerText = 'Date: ' + new Date().toLocaleDateString();

    // Add new row
    function addRow() {
      const table = document.getElementById('issueTable').getElementsByTagName('tbody')[0];
      const rowCount = table.rows.length;
      const row = table.insertRow();
      for(let i = 0; i < 6; i++) {
        let cell = row.insertCell(i);
        if(i === 0) {
          cell.innerText = rowCount + 1;
        } else {
          cell.contentEditable = "true";
          cell.style.background = "#fffbe4";
        }
      }
      updateCloseRateChart();
    }

    // Listen for table changes to update the ranking
    document.getElementById('issueTable').addEventListener('input', updateCloseRateChart);
    document.getElementById('issueTable').addEventListener('blur', updateCloseRateChart, true);

    // Calculate and draw the close rate ranking
    function updateCloseRateChart() {
      const table = document.getElementById('issueTable').getElementsByTagName('tbody')[0];
      const ownerStats = {};
      for(let i = 0; i < table.rows.length; i++) {
        const row = table.rows[i];
        const owner = row.cells[2].innerText.trim();
        const status = row.cells[4].innerText.trim().toLowerCase();
        if(owner) {
          if(!ownerStats[owner]) ownerStats[owner] = {total: 0, closed: 0};
          ownerStats[owner].total += 1;
          if(status === "closed" || status === "已关闭" || status === "done" || status === "完成") {
            ownerStats[owner].closed += 1;
          }
        }
      }
      // Prepare data for Chart.js
      const owners = Object.keys(ownerStats);
      const rates = owners.map(o => ownerStats[o].total > 0 ? (ownerStats[o].closed / ownerStats[o].total * 100).toFixed(1) : 0);
      // Sort ranking
      const sorted = owners.map((o,i)=>({owner:o,rate:parseFloat(rates[i])}))
        .sort((a,b)=>b.rate-a.rate);
      // Draw chart
      const ctx = document.getElementById('closeRateChart').getContext('2d');
      if(window.closeRateChartInstance) window.closeRateChartInstance.destroy();
      window.closeRateChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(x=>x.owner),
          datasets: [{
            label: 'Close Rate (%)',
            data: sorted.map(x=>x.rate),
            backgroundColor: '#43689b'
          }]
        },
        options: {
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, max: 100 }
          },
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: "Owner Close Rate Ranking"
            }
          }
        }
      });
    }

    // Initial draw
    updateCloseRateChart();
  </script>
</body>
</html>
