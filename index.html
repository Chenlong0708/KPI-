<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI协作周报系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 侧边栏+主内容区+成员管理弹窗 及表格样式（合并优化） */
        /* ...（因篇幅限制，见下方说明，样式请用你的任一版本即可，功能无影响）... */
        body { margin:0;padding:0;display:flex;min-height:100vh;font-family:'Segoe UI', 'Microsoft YaHei', sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#e4edf5 100%);}
        .sidebar{width:260px;background:#2c3e50;color:#fff;flex-shrink:0;display:flex;flex-direction:column;}
        .logo{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);}
        .logo h2{display:flex;align-items:center;gap:10px;}
        .nav-links{flex:1;}
        .nav-item{padding:12px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background 0.3s;}
        .nav-item:hover,.nav-item.active{background:rgba(255,255,255,0.1);}
        .main-content{flex:1;padding:20px;overflow-y:auto;}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:20px;}
        .date-range{display:flex;align-items:center;background:#fff;padding:12px 20px;border-radius:8px;font-weight:600;box-shadow:0 3px 10px rgba(0,0,0,0.05);}
        .user-controls{display:flex;gap:15px;align-items:center;}
        .btn{padding:12px 20px;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;}
        .btn-primary{background:linear-gradient(to right,#1a6dcc,#2c87e6);color:#fff;}
        .btn-success{background:linear-gradient(to right,#28a745,#3cc05a);color:#fff;}
        .btn-light{background:#fff;color:#2c87e6;}
        .table-container{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.08);margin-bottom:40px;overflow-x:auto;}
        table{width:100%;border-collapse:collapse;min-width:1200px;}
        th{background:linear-gradient(to bottom,#2c87e6,#1a6dcc);color:#fff;text-align:left;padding:18px 15px;font-weight:600;}
        td{padding:16px 15px;border-bottom:1px solid #eef2f7;}
        tr:nth-child(even){background-color:#f9fcff;}
        tr:hover{background-color:#f0f7ff;}
        input,textarea,select{width:100%;padding:12px 14px;border:1px solid #d1e0f0;border-radius:6px;font-size:0.95rem;}
        .add-row-btn{padding:15px;text-align:center;background:#f0f7ff;cursor:pointer;color:#2c87e6;font-weight:600;}
        .add-row-btn:hover{background:#e1eeff;}
        .remove-row{color:#dc3545;background:none;border:none;font-size:1.2rem;cursor:pointer;opacity:0.7;padding:5px;}
        .remove-row:hover{opacity:1;}
        .footer{text-align:center;padding:25px 0;color:#6c757d;font-size:0.95rem;border-top:1px solid #eaeff5;margin-top:20px;}
        .notification{position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:15px 25px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1000;transform:translateY(100px);opacity:0;transition:all 0.3s;}
        .notification.show{transform:translateY(0);opacity:1;}
        /* 成员管理弹窗样式 */
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.32);align-items:center;justify-content:center;}
        .modal-content{background:#fff;padding:25px 36px;border-radius:15px;min-width:350px;max-width:90vw;}
        .modal-content h3{margin-bottom:15px;}
        .member-list{margin-bottom:10px;}
        .member-item{display:flex;align-items:center;gap:10px;margin-bottom:7px;}
        .member-avatar2{width:36px;height:36px;border-radius:50%;background:#2c87e6;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;}
        .member-info2{flex:1;}
        .member-actions2 button{border:none;background:none;color:#dc3545;cursor:pointer;}
        .form-group{margin-bottom:10px;}
        .form-group label{display:block;margin-bottom:4px;}
        .form-group input{width:100%;padding:8px;}
        .modal-footer{display:flex;gap:8px;justify-content:flex-end;}
        @media (max-width:900px){.sidebar{width:100px;}.logo h2{font-size:1.1rem;}}
        @media (max-width:768px){body{flex-direction:column;}.sidebar{width:100%;padding:10px;}}
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="logo">
            <h2><i class="fas fa-chart-line"></i> KPI周报系统</h2>
        </div>
        <div class="nav-links">
            <div class="nav-item active"><i class="fas fa-home"></i> 周报中心</div>
            <div class="nav-item"><i class="fas fa-tasks"></i> 任务管理</div>
            <div class="nav-item"><i class="fas fa-chart-pie"></i> 数据看板</div>
            <div class="nav-item"><i class="fas fa-users"></i> 团队管理</div>
            <div class="nav-item"><i class="fas fa-cog"></i> 系统设置</div>
        </div>
        <div style="padding:15px;">
            <button class="btn btn-light" onclick="openMemberPanel()"><i class="fas fa-user-friends"></i> 团队成员管理</button>
        </div>
    </div>
    <!-- 主内容 -->
    <div class="main-content">
        <div class="header">
            <div class="date-range">
                <i class="far fa-calendar-alt"></i>
                <span>当前周期: <span id="current-week"></span></span>
            </div>
            <div class="user-controls">
                <button class="btn btn-primary" onclick="addNewRow()"><i class="fas fa-plus-circle"></i> 添加新行</button>
                <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> 导出Excel</button>
                <button class="btn btn-light" onclick="saveData()"><i class="fas fa-save"></i> 保存数据</button>
                <button class="btn btn-light" onclick="loadData()"><i class="fas fa-sync-alt"></i> 加载数据</button>
                <div class="btn btn-light" style="padding:6px 10px;">
                    <div class="user-avatar" id="main-user-avatar">王</div>
                    <input type="text" id="username" value="王芳" style="width:80px;background:transparent;border:none;">
                </div>
            </div>
        </div>
        <div class="table-container">
            <table id="kpi-table">
                <thead>
                    <tr>
                        <th width="14%">核心KPI (目标值)</th>
                        <th width="12%">支撑性关键行动/项目</th>
                        <th width="14%">本周重点回顾</th>
                        <th width="12%">完成状态/结果</th>
                        <th width="14%">下周重点计划</th>
                        <th width="12%">预期输出/截止日</th>
                        <th width="10%">责任人</th>
                        <th width="8%">状态</th>
                        <th width="4%"></th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div class="add-row-btn" onclick="addNewRow()"><i class="fas fa-plus-circle"></i> 添加新行</div>
        </div>
        <div class="footer">
            <p>© 2025 KPI协作周报系统 | 数据存储在您的浏览器本地</p>
            <p>最后保存时间: <span id="last-save-time">尚未保存</span> | 数据大小: <span id="data-size">0 KB</span></p>
        </div>
    </div>
    <!-- 成员管理弹窗 -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <h3>团队成员管理</h3>
            <div class="member-list" id="membersList"></div>
            <form id="addMemberForm" style="margin-bottom:10px;">
                <div class="form-group"><label>姓名</label><input type="text" id="memberName"></div>
                <div class="form-group"><label>职位</label><input type="text" id="memberRole"></div>
                <div class="form-group"><label>部门</label><input type="text" id="memberDepartment"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" onclick="closeMemberPanel()">取消</button>
                    <button type="submit" class="btn btn-success">保存</button>
                </div>
            </form>
        </div>
    </div>
    <div class="notification" id="notification">通知消息</div>
    <script>
    // ------- 团队成员管理 -------
    const initialMembers = [
        { id: 1, name: "张明", role: "项目经理", department: "项目管理" },
        { id: 2, name: "李华", role: "开发工程师", department: "技术部" },
        { id: 3, name: "王芳", role: "数据分析师", department: "分析部" },
        { id: 4, name: "赵雷", role: "产品经理", department: "产品部" }
    ];
    function loadMembers() {
        const local = localStorage.getItem('kpi_members');
        return local ? JSON.parse(local) : [...initialMembers];
    }
    let members = loadMembers();
    function saveMembers() {
        localStorage.setItem('kpi_members', JSON.stringify(members));
    }
    function renderMembers() {
        const membersList = document.getElementById('membersList');
        membersList.innerHTML = '';
        members.forEach(member => {
            const firstLetter = member.name.charAt(0);
            const el = document.createElement('div');
            el.className = 'member-item';
            el.innerHTML = `
                <div class="member-avatar2">${firstLetter}</div>
                <div class="member-info2">
                    <div><b>${member.name}</b> | ${member.role} | ${member.department}</div>
                </div>
                <div class="member-actions2">
                    <button onclick="deleteMember(${member.id})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            membersList.appendChild(el);
        });
    }
    function openMemberPanel() {
        renderMembers();
        document.getElementById('memberModal').style.display = 'flex';
    }
    function closeMemberPanel() {
        document.getElementById('memberModal').style.display = 'none';
    }
    function addMember(e) {
        e.preventDefault();
        const name = document.getElementById('memberName').value.trim();
        const role = document.getElementById('memberRole').value.trim();
        const department = document.getElementById('memberDepartment').value.trim();
        if (!name || !role || !department) {
            showNotification("请填写所有字段");
            return;
        }
        const newMember = {
            id: Date.now(),
            name, role, department
        };
        members.push(newMember);
        saveMembers();
        renderMembers();
        // 清空表单
        document.getElementById('memberName').value = '';
        document.getElementById('memberRole').value = '';
        document.getElementById('memberDepartment').value = '';
        showNotification("成员已添加");
    }
    function deleteMember(id) {
        if (confirm('确定要删除此成员吗？')) {
            members = members.filter(m => m.id !== id);
            saveMembers();
            renderMembers();
            showNotification("成员已删除");
        }
    }
    document.getElementById('addMemberForm').addEventListener('submit', addMember);

    // ------- KPI表格管理 -------
    const initialData = [
        {
            kpi: "客户满意度 (CSAT) ≥ 90%",
            action: "1. 提升响应速度",
            review: "1.1 完成客服团队新响应流程培训 (计划内)",
            status: "1.1 完成",
            plan: "1.1 监控新流程执行情况，收集首周反馈",
            output: "问题单平均响应时间 < 2小时 (目标)",
            responsible: "张明",
            state: "planned"
        }
    ];
    function showNotification(message, duration = 3000) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, duration);
    }
    function addNewRow() {
        const tbody = document.getElementById('table-body');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" placeholder="输入KPI和目标值"></td>
            <td><input type="text" placeholder="关键行动/项目"></td>
            <td><textarea placeholder="上周计划完成情况"></textarea></td>
            <td><textarea placeholder="完成状态/结果"></textarea></td>
            <td><textarea placeholder="下周关键任务"></textarea></td>
            <td><textarea placeholder="预期输出/截止日"></textarea></td>
            <td><input type="text" placeholder="责任人"></td>
            <td>
                <select class="status-select status-planned">
                    <option value="planned" selected>计划中</option>
                    <option value="in-progress">进行中</option>
                    <option value="completed">已完成</option>
                    <option value="blocked">受阻</option>
                </select>
            </td>
            <td><button class="remove-row" onclick="removeRow(this)">×</button></td>
        `;
        tbody.appendChild(newRow);
        showNotification("新行已添加，开始填写内容吧！");
    }
    function removeRow(button) {
        const row = button.closest('tr');
        row.remove();
        showNotification("行已删除");
    }
    function exportToExcel() {
        const table = document.getElementById('kpi-table');
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "KPI周报");
        const today = new Date();
        const dateStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
        XLSX.writeFile(wb, `团队KPI周报_${dateStr}.xlsx`);
        showNotification("Excel文件已导出成功！");
    }
    document.addEventListener('change', function(e) {
        if (e.target.tagName === 'SELECT' && e.target.classList.contains('status-select')) {
            e.target.classList.remove('status-planned', 'status-in-progress', 'status-completed', 'status-blocked');
            switch(e.target.value) {
                case 'planned':e.target.classList.add('status-planned'); break;
                case 'in-progress':e.target.classList.add('status-in-progress'); break;
                case 'completed':e.target.classList.add('status-completed'); break;
                case 'blocked':e.target.classList.add('status-blocked'); break;
            }
            showNotification("状态已更新");
            saveData();
        }
    });
    function saveData() {
        const tableData = [];
        const rows = document.querySelectorAll('#table-body tr');
        rows.forEach(row => {
            const rowData = {
                kpi: row.cells[0].querySelector('input').value,
                action: row.cells[1].querySelector('input').value,
                review: row.cells[2].querySelector('textarea').value,
                status: row.cells[3].querySelector('textarea').value,
                plan: row.cells[4].querySelector('textarea').value,
                output: row.cells[5].querySelector('textarea').value,
                responsible: row.cells[6].querySelector('input').value,
                state: row.cells[7].querySelector('select').value
            };
            tableData.push(rowData);
        });
        localStorage.setItem('kpiData', JSON.stringify(tableData));
        const now = new Date();
        document.getElementById('last-save-time').textContent = now.toLocaleString();
        const dataSize = (JSON.stringify(tableData).length / 1024).toFixed(2);
        document.getElementById('data-size').textContent = `${dataSize} KB`;
        showNotification("数据已保存到本地存储！");
    }
    function loadData() {
        const savedData = localStorage.getItem('kpiData');
        const tableData = savedData ? JSON.parse(savedData) : initialData;
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        tableData.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${item.kpi || ''}"></td>
                <td><input type="text" value="${item.action || ''}"></td>
                <td><textarea>${item.review || ''}</textarea></td>
                <td><textarea>${item.status || ''}</textarea></td>
                <td><textarea>${item.plan || ''}</textarea></td>
                <td><textarea>${item.output || ''}</textarea></td>
                <td><input type="text" value="${item.responsible || ''}"></td>
                <td>
                    <select class="status-select">
                        <option value="planned" ${item.state === 'planned' ? 'selected' : ''}>计划中</option>
                        <option value="in-progress" ${item.state === 'in-progress' ? 'selected' : ''}>进行中</option>
                        <option value="completed" ${item.state === 'completed' ? 'selected' : ''}>已完成</option>
                        <option value="blocked" ${item.state === 'blocked' ? 'selected' : ''}>受阻</option>
                    </select>
                </td>
                <td><button class="remove-row" onclick="removeRow(this)">×</button></td>
            `;
            const select = row.querySelector('select');
            select.classList.add(`status-${item.state || 'planned'}`);
            tbody.appendChild(row);
        });
        showNotification("数据已从本地存储加载！");
    }
    document.getElementById('username').addEventListener('change', function() {
        document.getElementById('main-user-avatar').textContent = this.value.charAt(0);
        showNotification(`用户名已更新为: ${this.value}`);
    });
    // -------- 初始化 --------
    document.addEventListener('DOMContentLoaded', function() {
        // 设置当前周
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        const formatDate = date => `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
        document.getElementById('current-week').textContent = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
        loadData();
        setInterval(() => {
            if (document.querySelector('input:focus, textarea:focus, select:focus')) {
                saveData();
            }
        }, 30000);
    });
    </script>
</body>
</html>
